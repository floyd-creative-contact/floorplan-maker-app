<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Map Making App</title>
  <style>
    html, body { margin: 0; padding: 0; overflow: hidden; background: transparent; }
    canvas { border: 1px solid #888; display: block; }
    #canvas-wrapper { position: relative; }
  </style>
</head>
<body>
  <div id="canvas-wrapper">
    <canvas id="floorplan-canvas" width="1000" height="700"></canvas>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
  <script>
    const canvas = new fabric.Canvas('floorplan-canvas', {
      selection: true,
      backgroundColor: '#fff'
    });

    const gridSize = 50;
    let snapping = true;
    let showGrid = true;

    function drawGrid(size) {
      if (!showGrid) return;
      for (let i = 0; i < canvas.width; i += size) {
        canvas.add(new fabric.Line([i, 0, i, canvas.height], {
          stroke: '#eee',
          selectable: false,
          evented: false
        }));
      }
      for (let i = 0; i < canvas.height; i += size) {
        canvas.add(new fabric.Line([0, i, canvas.width, i], {
          stroke: '#eee',
          selectable: false,
          evented: false
        }));
      }
    }

    drawGrid(gridSize);

    canvas.on('object:moving', function (opt) {
      if (!snapping) return;
      opt.target.set({
        left: Math.round(opt.target.left / gridSize) * gridSize,
        top: Math.round(opt.target.top / gridSize) * gridSize
      });
    });

    window.drawShape = function(type, polygonSides = 5) {
      let shape;
      switch (type) {
        case "Line":
          shape = new fabric.Line([100, 100, 300, 100], {
            stroke: 'black', strokeWidth: 2, objectCaching: false
          });
          break;
        case "Rectangle":
          shape = new fabric.Rect({
            left: 100, top: 100, width: 150, height: 100,
            fill: 'transparent', stroke: 'black', strokeWidth: 2
          });
          break;
        case "Circle/Ellipse":
          shape = new fabric.Ellipse({
            left: 100, top: 100, rx: 75, ry: 50,
            fill: 'transparent', stroke: 'black', strokeWidth: 2
          });
          break;
        case "Arc":
          shape = new fabric.Path('M 100 300 A 100 100 0 0 1 300 300', {
            fill: '', stroke: 'black', strokeWidth: 2
          });
          break;
        case "Polygon":
          const radius = 60;
          const points = [];
          for (let i = 0; i < polygonSides; i++) {
            const angle = (Math.PI * 2 * i) / polygonSides;
            points.push({
              x: radius * Math.cos(angle),
              y: radius * Math.sin(angle)
            });
          }
          shape = new fabric.Polygon(points, {
            left: 200, top: 200, fill: 'transparent', stroke: 'black', strokeWidth: 2
          });
          break;
      }
      canvas.add(shape);
    };

    window.toggleSnapping = function(state) {
      snapping = state;
    }

    window.toggleGrid = function(state) {
      showGrid = state;
      canvas.clear();
      if (showGrid) drawGrid(gridSize);
    }
  </script>
</body>
</html>
