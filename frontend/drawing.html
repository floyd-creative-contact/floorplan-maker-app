<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Celestial Library Floorplan Canvas</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: transparent;
    }
    canvas {
      border: 1px solid #888;
      display: block;
    }
    #canvas-wrapper {
      position: relative;
    }
  </style>
</head>
<body>
  <div id="canvas-wrapper">
    <canvas id="floorplan-canvas" width="1000" height="700"></canvas>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
  <script>
    const canvas = new fabric.Canvas('floorplan-canvas', {
      selection: true,
      backgroundColor: '#fff'
    });

    // Draw a grid with snap lines
    function drawGrid(gridSize) {
      for (let i = 0; i < canvas.width; i += gridSize) {
        canvas.add(new fabric.Line([i, 0, i, canvas.height], {
          stroke: '#eee',
          selectable: false,
          evented: false
        }));
      }
      for (let i = 0; i < canvas.height; i += gridSize) {
        canvas.add(new fabric.Line([0, i, canvas.width, i], {
          stroke: '#eee',
          selectable: false,
          evented: false
        }));
      }
    }

    drawGrid(50); // You can make this adjustable later

    // Add a line with snapping
    const gridSize = 50;

    canvas.on('object:moving', function (options) {
      options.target.set({
        left: Math.round(options.target.left / gridSize) * gridSize,
        top: Math.round(options.target.top / gridSize) * gridSize
      });
    });

    // Example tool (can be expanded)
    window.addLine = function () {
      const line = new fabric.Line([100, 100, 200, 100], {
        stroke: '#000',
        strokeWidth: 2,
        selectable: true
      });
      canvas.add(line);
    };

    // Export function (hooked up later)
    window.getCanvasImage = function () {
      const png = canvas.toDataURL({
        format: 'png',
        multiplier: 2
      });
      const data = {
        type: 'FROM_JS',
        data: png
      };
      window.parent.postMessage(data, '*');
    };
  </script>
</body>
</html>
